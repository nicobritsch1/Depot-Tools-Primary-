<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Replenishment Generator</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .page { display: none; }
    .active { display: block; }
    input, button, select { margin: 5px; padding: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    td, th { border: 1px solid #ccc; padding: 5px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Replenishment Generator</h2>
  <button onclick="window.location.href='index.html'">Home</button>
  <button onclick="switchPage('replenish')">Replenishment Generator</button>
  <button onclick="switchPage('settings')">Settings</button>

  <div id="settings" class="page">
    <h3>Item Settings</h3>
    <input id="desc" placeholder="SKU Description" />
    <input id="sku" placeholder="SKU" />
    <input id="unit" placeholder="Unit of Measure" />
    <input id="max" type="number" placeholder="Max Units" />
<input id="itemFA" type="number" step="0.01" placeholder="Freight Allocation (per item)" />
    <br/>
    <label for="freightAllocation" style="display:none;"><strong>Freight Allocation</strong> (legacy, not used)</label>
    <input id="freightAllocation" type="number" step="0.01" placeholder="e.g., 0.25" style="display:none;" />
    <button onclick="saveFreightAllocation()" style="display:none;">Save Settings</button>

    <button onclick="addItem()">Add Item</button>
    <table id="itemTable"></table>
  </div>

  <div id="replenish" class="page">
    <h3>Generate Replenishment File</h3>
    <label>Adjust Replenishment by: </label>
    <select id="adjustPercent">
      <option value="0">0%</option>
      <option value="10">10%</option>
      <option value="20">20%</option>
      <option value="30">30%</option>
    </select><br><br>
    <input type="file" id="rawFile" accept=".xlsx" />
    <button onclick="processRawData()">Generate Replenishment File</button>
    <p id="status"></p>
  </div>

  <script>
    let items = JSON.parse(localStorage.getItem('replenishItems')) || [];

    // --- Freight Allocation (global setting) ---
    function getFreightAllocation() {
      const val = localStorage.getItem('freightAllocation');
      const num = parseFloat(val);
      return isNaN(num) ? 0 : num;
    }
    function saveFreightAllocation() {
      const input = document.getElementById('freightAllocation');
      const val = parseFloat(input.value);
      if (isNaN(val)) { alert('Please enter a valid number for Freight Allocation'); return; }
      localStorage.setItem('freightAllocation', val.toString());
      alert('Freight Allocation saved.');
    }
    function renderFreightAllocation() {
      const input = document.getElementById('freightAllocation');
      if (input) input.value = getFreightAllocation();
    }


    function switchPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(page).classList.add('active');
      if (page === 'settings') { renderItems(); renderFreightAllocation(); }
    }

    function addItem() {
      const desc = document.getElementById('desc').value.trim();
      const sku = document.getElementById('sku').value.trim();
      const unit = document.getElementById('unit').value.trim();
      const max = parseInt(document.getElementById('max').value.trim());
      const freightAllocationPerItem = parseFloat(document.getElementById('itemFA').value.trim());
      if (!desc || !sku || !unit || isNaN(max)) return alert("Please fill in all fields");
      const freightAllocation = isNaN(freightAllocationPerItem) ? 0 : freightAllocationPerItem;
      items.push({ desc, sku, unit, max, freightAllocation });
      localStorage.setItem('replenishItems', JSON.stringify(items));
      document.getElementById('itemFA').value = '';
      renderItems();
    }

    function deleteItem(index) {
      items.splice(index, 1);
      localStorage.setItem('replenishItems', JSON.stringify(items));
      document.getElementById('itemFA').value = '';
      renderItems();
    }

    
function renderItems() {
  const table = document.getElementById('itemTable');
  if (!table) return;
  table.innerHTML = '<tr><th>Description</th><th>SKU</th><th>Unit</th><th>Max</th><th>Freight Allocation</th><th>Action</th></tr>';
  items.forEach((item, index) => {
    const fa = (item.freightAllocation !== undefined && item.freightAllocation !== null && item.freightAllocation !== "") 
      ? Number(item.freightAllocation) 
      : 0;
    const faDisplay = isNaN(fa) ? "" : fa;
    table.innerHTML += `<tr>
      <td>${item.desc ?? ""}</td>
      <td>${item.sku ?? ""}</td>
      <td>${item.unit ?? ""}</td>
      <td>${item.max ?? ""}</td>
      <td>${faDisplay}</td>
      <td><button onclick="deleteItem(${index})">Delete</button></td>
    </tr>`;
  });
}


    



function processRawData() {
  try {
    const file = document.getElementById("rawFile").files[0];
    if (!file) { alert("Please upload a raw data file"); return; }

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const firstSheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[firstSheetName];
        const raw = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        // Helper: normalize SKU -> digits-only string
        const normalizeSKU = (val) => {
          if (val === null || val === undefined) return "";
          let s = (typeof val === "number") ? Math.trunc(val).toString() : String(val).trim();
          s = s.replace(/\D+/g, "");
          return s;
        };

        // Map normalized SKU -> item
        const itemMap = {};
        (items || []).forEach(it => {
          const key = normalizeSKU(it.sku);
          if (key) itemMap[key] = it;
        });

        const percent = parseInt(document.getElementById("adjustPercent").value || "0");
        const missingSKUs = [];

        // First pass: build rows with freightAllocationAmount and store, no Total yet
        const tempRows = raw.map(row => {
          const storeNum = row["Store Number"] ?? row["Store"] ?? "";
          const skuRaw = row["SKU"] ?? row["Sku"] ?? row["sku"] ?? row["Item"] ?? row["Item #"] ?? "";
          const skuKey = normalizeSKU(skuRaw);
          const match = itemMap[skuKey];
          if (!match) { missingSKUs.push(skuRaw); }

          const currentRaw = row["Current On Hand"] ?? row["On Hand"] ?? row["current on hand"] ?? "";
          const current = parseInt(currentRaw);

          let replenishment = (match && !isNaN(current)) ? Math.max(match.max - current, 0) : 0;
          replenishment = Math.ceil(replenishment * (1 + (isNaN(percent) ? 0 : percent) / 100));

          const freightAllocation = match && !isNaN(parseFloat(match.freightAllocation))
            ? parseFloat(match.freightAllocation) : 0;
          const freightAllocationAmount = replenishment * freightAllocation;

          const desc = match ? match.desc : (row["SKU Description"] ?? row["Description"] ?? "");
          const unit = match ? match.unit : (row["Unit of Measure"] ?? row["Unit"] ?? "");

          return {
            storeNum,
            skuDisplay: skuKey || String(skuRaw ?? ""),
            desc,
            unit,
            current: isNaN(current) ? "" : current,
            maxUnits: match ? match.max : "",
            replenishment,
            freightAllocation: isNaN(freightAllocation) ? "" : freightAllocation,
            freightAllocationAmount: isNaN(freightAllocationAmount) ? 0 : Math.round((freightAllocationAmount + Number.EPSILON) * 100) / 100
          };
        });

        // Build per-store totals of freightAllocationAmount
        const storeTotals = {};
        tempRows.forEach(r => {
          const key = r.storeNum || "";
          const amt = Number(r.freightAllocationAmount) || 0;
          storeTotals[key] = (storeTotals[key] || 0) + amt;
        });
        // Round totals to 2 decimals
        Object.keys(storeTotals).forEach(k => {
          storeTotals[k] = Math.round((storeTotals[k] + Number.EPSILON) * 100) / 100;
        });

        // Second pass: produce final output with Column J = Total
        const output = tempRows.map(r => ({
          "Store Number": r.storeNum,
          "SKU": r.skuDisplay,
          "SKU Description": r.desc,
          "Unit of Measure": r.unit,
          "Current On Hand": r.current,
          "Max Units": r.maxUnits,
          "Replenishment Needed": r.replenishment,
          "Freight Allocation (per unit)": r.freightAllocation,
          "Freight Allocation Amount": r.freightAllocationAmount,
          "Total": storeTotals[r.storeNum || ""] || 0
        }));

        if (missingSKUs.length > 0) {
          alert("The following SKUs are missing from Replenishment Settings:\n" + [...new Set(missingSKUs)].join(", "));
        }

        const ws = XLSX.utils.json_to_sheet(output);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Replenishment");
        XLSX.writeFile(wb, "replenishment_output.xlsx");
        document.getElementById("status").innerText = "Replenishment file downloaded.";
      } catch (err) {
        console.error(err);
        alert("Failed to process file: " + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  } catch (e) {
    console.error(e);
    alert("Error: " + e.message);
  }
}





    switchPage('replenish');
  </script>
</body>
</html>
